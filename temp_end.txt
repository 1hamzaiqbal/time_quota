
// Get a random quote based on task ID for consistency
const getQuoteForTask = (taskId) => {
  if (!taskId) return INSPIRATIONAL_QUOTES[0];
  // Use task ID to generate a consistent index
  let hash = 0;
  for (let i = 0; i < taskId.length; i++) {
    hash = ((hash << 5) - hash) + taskId.charCodeAt(i);
    hash = hash & hash; // Convert to 32bit integer
  }
  const index = Math.abs(hash) % INSPIRATIONAL_QUOTES.length;
  return INSPIRATIONAL_QUOTES[index];
};

// Flexible Parser
const parseFlexibleInput = (input, defaultUnit = 'h') => {
  if (!input) return 0;
  const str = input.toString().trim().toLowerCase();
  
  if (str.includes(':')) {
    const parts = str.split(':');
    const h = parseInt(parts[0]) || 0;
    const m = parseInt(parts[1]) || 0;
    return (h * 60) + m;
  }

  if (str.includes('h')) return Math.round(parseFloat(str) * 60);
  if (str.includes('m')) return Math.round(parseFloat(str));

  const val = parseFloat(str);
  if (isNaN(val)) return 0;

  if (defaultUnit === 'h') return Math.round(val * 60);
  return Math.round(val);
};

// --- Reusable Input Component ---
const SmartInput = ({ valueMinutes, onCommit, className, placeholder, unit = 'h' }) => {
  const [text, setText] = useState('');
  
  useEffect(() => {
    if (unit === 'h' && valueMinutes > 0) {
      const h = parseFloat((valueMinutes / 60).toFixed(2));
      setText(h + 'h');
    } else if (unit === 'm' && valueMinutes > 0) {
       setText(valueMinutes); 
    } else {
       setText('');
    }
  }, [valueMinutes, unit]);

  const handleBlur = () => {
    const mins = parseFlexibleInput(text, unit);
    if (mins >= 0) onCommit(mins);
    
    if (unit === 'h' && mins > 0) {
      setText(parseFloat((mins / 60).toFixed(2)) + 'h');
    } else if (unit === 'h') {
      setText('');
    }
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter') e.target.blur();
  };

  return (
    <input
      type="text"
      value={text}
      placeholder={placeholder}
      onChange={(e) => setText(e.target.value)}
      onBlur={handleBlur}
      onKeyDown={handleKeyDown}
      className={className}
    />
  );
};

export default function App() {
  // --- State ---
  const [tasks, setTasks] = useState(() => {
    const saved = localStorage.getItem('timeblock-tasks');
    if (saved) {
      const parsed = JSON.parse(saved);
      return parsed.map(t => ({ 
        notes: '', 
        history: [], 
        currentSession: 0, 
        sessionGoal: 0,
        showTimer: true, // Default to showing the timer numbers
        dueDate: null,
        ...t 
      }));
    }
    return [
      { id: '1', title: 'Deep Work', quotaMinutes: 600, elapsed: 3600, isRunning: false, colorIndex: 7, notes: '- Finish the Q3 report', history: [], currentSession: 0, sessionGoal: 0, showTimer: true, dueDate: null },
      { id: '2', title: 'Email Triaging', quotaMinutes: 60, elapsed: 0, isRunning: false, colorIndex: 4, notes: '', history: [], currentSession: 0, sessionGoal: 0, showTimer: true, dueDate: null },
    ];
  });

  const [draggedItemIndex, setDraggedItemIndex] = useState(null);
  const [activeTaskId, setActiveTaskId] = useState(null); 
  const [isColorPickerOpen, setIsColorPickerOpen] = useState(false);
  const [isHistoryOpen, setIsHistoryOpen] = useState(true); 
  
  const [editingHistoryId, setEditingHistoryId] = useState(null);

  // --- Timer Logic ---
  useEffect(() => {
    const interval = setInterval(() => {
      setTasks(currentTasks => 
        currentTasks.map(task => {
          if (task.isRunning) {
            return { 
              ...task, 
              elapsed: task.elapsed + 1,
              currentSession: (task.currentSession || 0) + 1 
            };
          }
          return task;
        })
      );
    }, 1000);

    return () => clearInterval(interval);
  }, []);

  useEffect(() => {
    localStorage.setItem('timeblock-tasks', JSON.stringify(tasks));
  }, [tasks]);
  
  useEffect(() => {
    setIsColorPickerOpen(false);
    setEditingHistoryId(null); 
  }, [activeTaskId]);

  // --- Keyboard Handler ---
  useEffect(() => {
    const handleKeyDown = (e) => {
      if (e.key === 'Escape' && activeTaskId) {
        setActiveTaskId(null);
        setIsColorPickerOpen(false);
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [activeTaskId]);

  // --- Handlers ---
  const addTask = () => {
    const newColorIndex = Math.floor(Math.random() * COLORS.length);
    const newTask = {
      id: crypto.randomUUID(),
      title: 'New Task',
      quotaMinutes: 60, 
      elapsed: 0,
      isRunning: false,
      colorIndex: newColorIndex,
      notes: '',
      history: [],
      currentSession: 0,
      sessionGoal: 0,
      showTimer: true,
      dueDate: null
    };
    setTasks([...tasks, newTask]);
  };

  const removeTask = (id) => {
    setTasks(tasks.filter(t => t.id !== id));
    if (activeTaskId === id) setActiveTaskId(null);
  };

  const toggleTimer = (id) => {
    setTasks(tasks.map(t => {
      if (t.id === id) {
        return { ...t, isRunning: !t.isRunning };
      }
      return t;
    }));
  };

  const toggleCardView = (id) => {
    setTasks(tasks.map(t => 
      t.id === id ? { ...t, showTimer: !t.showTimer } : t
    ));
  };

  const stopSession = (id) => {
    setTasks(tasks.map(t => {
      if (t.id === id) {
        if (t.currentSession > 0) {
           const sessionEntry = {
            id: crypto.randomUUID(),
            type: 'session',
            amount: t.currentSession,
            timestamp: Date.now()
          };
          return { 
            ...t, 
            isRunning: false, 
            currentSession: 0, 
            sessionGoal: 0, 
            history: [sessionEntry, ...t.history] 
          };
        } else {
           return { ...t, isRunning: false, currentSession: 0, sessionGoal: 0 };
        }
      }
      return t;
    }));
  };

  const resetTotalTimer = (id) => {
    setTasks(tasks.map(t => 
        t.id === id ? { ...t, elapsed: 0, isRunning: false, currentSession: 0, sessionGoal: 0, history: [] } : t
    ));
  };

  const updateTask = (id, field, value) => {
    setTasks(tasks.map(t => 
      t.id === id ? { ...t, [field]: value } : t
    ));
  };
  
  const addManualTime = (id, minsToAdd) => {
    const secondsToAdd = minsToAdd * 60;
    const logEntry = {
        id: crypto.randomUUID(),
        type: 'manual',
        amount: secondsToAdd,
        timestamp: Date.now()
    };

    setTasks(tasks.map(t => 
        t.id === id ? { 
            ...t, 
            elapsed: Math.max(0, t.elapsed + secondsToAdd),
            history: [logEntry, ...t.history]
        } : t
    ));
  };

  // --- History Edit Handlers ---
  const deleteHistoryEntry = (taskId, entryId) => {
    setTasks(tasks.map(t => {
        if (t.id !== taskId) return t;
        
        const entryToRemove = t.history.find(h => h.id === entryId);
        if (!entryToRemove) return t;

        return {
            ...t,
            elapsed: Math.max(0, t.elapsed - entryToRemove.amount),
            history: t.history.filter(h => h.id !== entryId)
        };
    }));
  };

  const updateHistoryEntry = (taskId, entryId, newMinutes) => {
    setTasks(tasks.map(t => {
        if (t.id !== taskId) return t;
        
        const entryToUpdate = t.history.find(h => h.id === entryId);
        if (!entryToUpdate) return t;

        const newAmountSeconds = newMinutes * 60;
        const diff = newAmountSeconds - entryToUpdate.amount;

        return {
            ...t,
            elapsed: Math.max(0, t.elapsed + diff), // Adjust total based on diff
            history: t.history.map(h => h.id === entryId ? { ...h, amount: newAmountSeconds } : h)
        };
    }));
    setEditingHistoryId(null);
  };

  // --- Drag and Drop Handlers ---
  const handleDragStart = (e, index) => {
    setDraggedItemIndex(index);
    e.dataTransfer.effectAllowed = "move";
  };

  const handleDragOver = (e, index) => {
    e.preventDefault();
    if (draggedItemIndex === null) return;
    if (draggedItemIndex !== index) {
      const newTasks = [...tasks];
      const draggedItem = newTasks[draggedItemIndex];
      newTasks.splice(draggedItemIndex, 1);
      newTasks.splice(index, 0, draggedItem);
      setTasks(newTasks);
      setDraggedItemIndex(index);
    }
  };

  const handleDragEnd = () => {
    setDraggedItemIndex(null);
  };

  const activeTask = tasks.find(t => t.id === activeTaskId);
  const activeColors = activeTask ? COLORS[activeTask.colorIndex % COLORS.length] : null;

  return (
    <div className="min-h-screen bg-slate-900 text-slate-100 p-4 sm:p-8 font-sans selection:bg-slate-700">

      {/* Grid */}
      <div className="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">
        {tasks.map((task, index) => {
          const colors = COLORS[task.colorIndex % COLORS.length];
          
          // --- Calculations ---
          const quotaSeconds = task.quotaMinutes * 60;
          const totalProgressPercent = Math.min(100, (task.elapsed / quotaSeconds) * 100);
          
          // Session Goal Logic
          const sessionGoalSeconds = (task.sessionGoal || 0) * 60;
          const hasSessionGoal = sessionGoalSeconds > 0;
          const currentSessionSeconds = task.currentSession || 0;
          
          const sessionProgressPercent = hasSessionGoal 
            ? Math.min(100, (currentSessionSeconds / sessionGoalSeconds) * 100)
            : 0;

          // Visual States
          const isOvertime = task.elapsed > quotaSeconds;
          const isQuotaMet = task.elapsed >= quotaSeconds;
          const isSessionMet = hasSessionGoal && currentSessionSeconds >= sessionGoalSeconds;
          const hasNotes = task.notes && task.notes.trim().length > 0;
          
          // Due Date Calculations
          const daysLeft = getDaysLeft(task.dueDate);
          const avgHoursPerDay = daysLeft !== null ? getAvgHoursPerDay(task.quotaMinutes, task.elapsed, daysLeft) : null;

          // Card classes
          const cardGlowClass = isSessionMet ? 'shadow-emerald-400/40 ring-2 ring-emerald-400' : 'hover:shadow-xl';
          
          return (
            <div 
              key={task.id}
              draggable
              onDragStart={(e) => handleDragStart(e, index)}
              onDragOver={(e) => handleDragOver(e, index)}
              onDragEnd={handleDragEnd}
              className={`
                relative group
                ${colors.bg} ${colors.border} border-2
                rounded-3xl p-6
                transition-all duration-300 ease-out
                ${cardGlowClass} hover:scale-[1.02]
                cursor-grab active:cursor-grabbing
                flex flex-col justify-between
                min-h-[260px]
              `}
            >
              {/* Controls Overlay (Drag) - Eye button removed */}
              <div className="absolute top-4 right-4 z-20 flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                 <div className="text-slate-400/50 cursor-grab">
                    <GripHorizontal className="w-5 h-5" />
                 </div>
              </div>

              {/* Top Section */}
              <div className="space-y-4 z-10">
                <input 
                  value={task.title}
                  onChange={(e) => updateTask(task.id, 'title', e.target.value)}
                  className={`w-full bg-transparent text-xl font-bold ${colors.text} placeholder-slate-400/50 outline-none border-none focus:ring-0 p-0 truncate text-center`}
                  placeholder="Task Name"
                />
                
                {/* Quota display logic - Hidden in Focus Mode to reduce noise? Or kept minimal */}
                <div className={`flex flex-col items-center gap-2 opacity-80 ${!task.showTimer ? 'invisible' : ''}`}>
                   <div className="flex items-center gap-2">
                     <span className={`text-xs font-bold uppercase tracking-wider ${colors.text}`}>Quota</span>
                     <SmartInput
                        valueMinutes={task.quotaMinutes}
                        onCommit={(mins) => updateTask(task.id, 'quotaMinutes', mins)}
                        unit="h"
                        className={`w-20 bg-white/40 backdrop-blur-sm rounded-lg px-2 py-1 text-sm font-mono font-semibold ${colors.text} outline-none focus:ring-2 focus:ring-white/50 text-center`}
                     />
                   </div>
                   {/* Due Date Info */}
                   {daysLeft !== null && (
                     <div className={`text-xs ${colors.text} opacity-75 text-center`}>
                       {daysLeft > 0 ? (
                         <>
                           <span className="font-semibold">{daysLeft} {daysLeft === 1 ? 'day' : 'days'} left</span>
                           {avgHoursPerDay !== null && avgHoursPerDay > 0 && (
                             <span className="mx-1">•</span>
                           )}
                           {avgHoursPerDay !== null && avgHoursPerDay > 0 && (
                             <span>{avgHoursPerDay.toFixed(1)}h/day needed</span>
                           )}
                         </>
                       ) : daysLeft === 0 ? (
                         <span className="font-semibold text-red-500">Due today!</span>
                       ) : (
                         <span className="font-semibold text-red-500">Overdue by {Math.abs(daysLeft)} {Math.abs(daysLeft) === 1 ? 'day' : 'days'}</span>
                       )}
                     </div>
                   )}
                </div>
              </div>

              {/* Middle Content Area - CLICKABLE TO TOGGLE FOCUS */}
              <div 
                onClick={() => toggleCardView(task.id)}
                className="flex flex-col items-center justify-center flex-1 my-2 cursor-pointer select-none hover:opacity-80 transition-opacity"
                title={task.showTimer ? "Click to Enter Focus Mode" : "Click to Show Timer"}
              >
                {task.showTimer ? (
                    // Standard View: Timer
                    <>
                        <div className={`text-5xl font-mono font-bold tracking-tight ${isOvertime ? 'text-red-500' : colors.text}`}>
                        {formatTime(task.elapsed)}
                        </div>
                        {isOvertime && (
                        <div className="flex items-center gap-1 text-red-500 text-xs font-bold mt-1 animate-pulse">
                            <AlertCircle className="w-3 h-3" />
                            <span>OVER LIMIT</span>
                        </div>
                        )}
                    </>
                ) : (
                    // Focus View: Minimal
                    <div className="flex flex-col items-center justify-center space-y-4 w-full">
                        {isSessionMet && (
                             <div className="flex items-center gap-2 text-emerald-600 bg-emerald-100 px-3 py-1 rounded-full animate-in zoom-in">
                                <Trophy className="w-5 h-5 fill-current" />
                                <span className="text-sm font-bold">Goal Met!</span>
                             </div>
                        )}
                        {/* We just leave space empty or show motivational icon if idle */}
                        {!isSessionMet && <div className={`w-2 h-2 rounded-full ${colors.dot} opacity-50`} />}
                    </div>
                )}
              </div>

              {/* Bottom Controls & Bars */}
              <div className="space-y-3 z-10 w-full">
                
                {/* Progress Bars Container */}
                <div className="space-y-1">
                    {/* Main Total Progress Bar */}
                    <div className="h-3 w-full bg-white/40 rounded-full overflow-hidden relative">
                        <div 
                            className={`h-full transition-all duration-500 ease-linear ${isOvertime ? 'bg-red-500' : colors.bar}`}
                            style={{ width: `${totalProgressPercent}%` }}
                        />
                        {isOvertime && (
                            <div className="absolute inset-0 bg-[linear-gradient(45deg,transparent_25%,rgba(255,255,255,0.3)_50%,transparent_75%)] bg-[length:20px_20px] animate-stripes pointer-events-none" />
                        )}
                    </div>

                    {/* Session Goal Bar */}
                    {hasSessionGoal && (
                        <div className="pt-1 flex items-center gap-2">
                            <div className="h-2 w-full bg-white/20 rounded-full overflow-hidden relative flex-1">
                                <div 
                                    className={`
                                        h-full transition-all duration-200 ease-linear 
                                        ${isSessionMet ? 'bg-emerald-400' : colors.sessionBar}
                                    `}
                                    style={{ width: `${sessionProgressPercent}%` }}
                                />
                            </div>
                            {isSessionMet && <Trophy className="w-3 h-3 text-emerald-600 animate-bounce" />}
                        </div>
                    )}
                </div>

                {/* Controls */}
                <div className="flex items-center justify-between pt-2">
                  <div className="flex gap-2">
                    {/* Play/Pause */}
                    <button 
                        onClick={() => toggleTimer(task.id)}
                        className={`p-3 rounded-xl transition-colors ${task.isRunning ? 'bg-slate-800 text-white hover:bg-slate-700' : 'bg-white text-slate-800 hover:bg-white/80'} shadow-sm`}
                    >
                        {task.isRunning ? <Pause className="w-5 h-5" /> : <Play className="w-5 h-5 ml-0.5" />}
                    </button>
                    
                    {/* Stop (End Session) */}
                    <button 
                        onClick={() => stopSession(task.id)}
                        className={`p-3 rounded-xl transition-colors bg-white/40 hover:bg-white/80 ${colors.text} shadow-sm`}
                        title="Stop Session & Log Time"
                    >
                        <Square className="w-5 h-5 fill-current" />
                    </button>
                  </div>

                  <div className="flex gap-2">
                    <button 
                        onClick={() => setActiveTaskId(task.id)}
                        className={`p-3 rounded-xl transition-colors hover:bg-white/50 ${colors.text} ${hasNotes ? 'bg-white/30' : ''}`}
                        title="Notes, History & Details"
                      >
                        <FileText className={`w-5 h-5 ${hasNotes ? 'fill-current' : ''}`} />
                    </button>
                    
                    <button 
                      onClick={() => removeTask(task.id)}
                      className="p-3 rounded-xl text-slate-400 hover:text-red-500 hover:bg-red-100/50 transition-colors"
                      title="Delete"
                    >
                      <Trash2 className="w-5 h-5" />
                    </button>
                  </div>
                </div>
              </div>

            </div>
          );
        })}
      </div>

      {/* Empty State */}
      {tasks.length === 0 && (
        <div className="text-center mt-20 opacity-40">
          <div className="inline-block p-6 rounded-full bg-slate-800 mb-4">
             <Clock className="w-12 h-12 text-slate-500" />
          </div>
          <p className="text-slate-400 text-lg">No tasks yet. Add a block to get started.</p>
        </div>
      )}

      {/* Add Block Button - Fixed Bottom Right */}
      <button 
        onClick={addTask}
        className="fixed bottom-6 right-6 flex items-center gap-2 px-6 py-3 bg-violet-300 hover:bg-violet-200 active:bg-violet-400 text-violet-900 rounded-full font-semibold transition-all shadow-lg hover:shadow-violet-300/40 transform hover:-translate-y-0.5 z-40 backdrop-blur-sm"
      >
        <Plus className="w-5 h-5" />
        Add Block
      </button>

      {/* Expanded Task Modal */}
      {activeTask && activeColors && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm animate-in fade-in duration-200">
          <div 
            className={`
              w-full max-w-2xl h-[85vh] flex flex-col
              ${activeColors.bg} ${activeColors.border} border-4
              rounded-3xl shadow-2xl shadow-black/50
              relative overflow-hidden
              animate-in zoom-in-95 duration-200
            `}
          >
            {/* Modal Header */}
            <div className={`p-6 flex items-start justify-between border-b ${activeColors.border} bg-white/20 relative z-20`}>
              <div className="flex-1 mr-4">
                <input 
                  value={activeTask.title}
                  onChange={(e) => updateTask(activeTask.id, 'title', e.target.value)}
                  className={`w-full bg-transparent text-3xl font-bold ${activeColors.text} placeholder-slate-400/50 outline-none border-none focus:ring-0 p-0`}
                  placeholder="Task Name"
                />
                <div className="flex items-center gap-4 mt-2 text-sm font-medium opacity-75">
                   <span className={`${activeColors.text}`}>Goal: {(activeTask.quotaMinutes / 60).toFixed(1)}h</span>
                   <span className={`${activeColors.text}`}>•</span>
                   <span className={`${activeColors.text} font-mono`}>
                      Total: {formatTime(activeTask.elapsed)}
                   </span>
                </div>
              </div>

              {/* Controls: Reset, Color Picker, Close */}
              <div className="flex items-center gap-2">
                
                {/* Reset Button (Total) */}
                <button 
                  onClick={() => resetTotalTimer(activeTask.id)}
                  className={`
                    w-10 h-10 rounded-full ${activeColors.text} bg-white/30
                    hover:bg-white/50 transition-colors flex items-center justify-center
                  `}
                  title="Reset Total Progress"
                >
                  <RotateCcw className="w-5 h-5" />
                </button>

                {/* Color Picker */}
                <div className="relative">
                  <button 
                    onClick={() => setIsColorPickerOpen(!isColorPickerOpen)}
                    className={`
                      w-10 h-10 rounded-full ${activeColors.dot} 
                      border-4 border-white/50 shadow-sm 
                      hover:scale-105 transition-transform
                      flex items-center justify-center
                    `}
                    title="Change Color"
                  />
                  
                  {isColorPickerOpen && (
                    <div className="absolute top-full right-0 mt-2 p-3 bg-white rounded-2xl shadow-xl border border-slate-100 grid grid-cols-5 gap-2 w-[200px] animate-in fade-in zoom-in-95 z-50">
                        {COLORS.map((c, i) => (
                          <button
                            key={i}
                            onClick={() => {
                              updateTask(activeTask.id, 'colorIndex', i);
                              setIsColorPickerOpen(false);
                            }}
                            className={`
                              w-8 h-8 rounded-full ${c.dot}
                              border-2 transition-transform
                              ${activeTask.colorIndex === i ? 'border-slate-800 scale-110 shadow-sm' : 'border-transparent hover:scale-110'}
                            `}
                          />
                        ))}
                    </div>
                  )}
                </div>

                <button 
                  onClick={() => setActiveTaskId(null)}
                  className={`p-2 rounded-full hover:bg-black/10 transition-colors ${activeColors.text}`}
                >
                  <X className="w-8 h-8" />
                </button>
              </div>
            </div>

            {/* Modal Body */}
            <div className="flex-1 overflow-hidden flex flex-col md:flex-row">
              
              {/* Notes Section (Main Area) */}
              <div className="flex-1 p-6 flex flex-col">
                <div className="flex items-center gap-2 mb-3 opacity-70">
                  <FileText className={`w-4 h-4 ${activeColors.text}`} />
                  <span className={`text-xs font-bold uppercase tracking-wider ${activeColors.text}`}>Notes</span>
                </div>
                <textarea
                  value={activeTask.notes}
                  onChange={(e) => updateTask(activeTask.id, 'notes', e.target.value)}
                  placeholder={getQuoteForTask(activeTask.id)}
                  className={`
                    flex-1 w-full resize-none
                    bg-white/40 rounded-xl p-4
                    ${activeColors.text} placeholder-slate-500/50 italic
                    text-lg leading-relaxed
                    outline-none focus:ring-2 focus:ring-white/50
                    border-none
                  `}
                />
              </div>

              {/* Sidebar Controls */}
              <div className={`p-6 md:w-72 flex flex-col gap-6 border-t md:border-t-0 md:border-l ${activeColors.border} bg-white/10 overflow-y-auto`}>
                
                {/* Timer Display (Small in Sidebar) */}
                <div className="text-center p-4 bg-white/30 rounded-2xl shadow-sm">
                  <div className={`text-3xl font-mono font-bold tracking-tight mb-2 ${activeTask.elapsed > activeTask.quotaMinutes * 60 ? 'text-red-600' : activeColors.text}`}>
                    {formatTime(activeTask.elapsed)}
                  </div>
                  <div className="flex justify-center gap-2">
                    <button 
                        onClick={() => toggleTimer(activeTask.id)}
                        className={`flex-1 py-2 rounded-lg font-bold transition-colors shadow-sm flex items-center justify-center gap-2 ${activeTask.isRunning ? 'bg-slate-800 text-white hover:bg-slate-700' : 'bg-white text-slate-800 hover:bg-white/90'}`}
                      >
                        {activeTask.isRunning ? 'Pause' : 'Start'}
                    </button>
                     <button 
                        onClick={() => stopSession(activeTask.id)}
                        className={`p-2 rounded-lg bg-white/50 hover:bg-white/80 ${activeColors.text}`}
                        title="Stop & Log"
                    >
                        <Square className="w-5 h-5 fill-current" />
                    </button>
                  </div>
                </div>

                {/* Settings Group */}
                <div className="space-y-4">
                    
                    {/* Quota */}
                    <div className="space-y-1">
                    <label className={`text-xs font-bold uppercase tracking-wider ${activeColors.text} opacity-80`}>
                        Total Quota
                    </label>
                    <SmartInput
                        valueMinutes={activeTask.quotaMinutes}
                        onCommit={(mins) => updateTask(activeTask.id, 'quotaMinutes', mins)}
                        unit="h"
                        placeholder="e.g. 1.5"
                        className={`w-full bg-white/40 rounded-lg py-2 text-center font-mono font-bold ${activeColors.text} outline-none focus:ring-2 focus:ring-white/50`}
                    />
                    </div>

                    {/* Session Goal (Intention) */}
                    <div className="space-y-1">
                        <label className={`text-xs font-bold uppercase tracking-wider ${activeColors.text} opacity-80 flex items-center gap-1`}>
                            <Target className="w-3 h-3" /> Session Goal
                        </label>
                        <SmartInput
                            valueMinutes={activeTask.sessionGoal}
                            onCommit={(mins) => updateTask(activeTask.id, 'sessionGoal', mins)}
                            unit="m"
                            placeholder="e.g. 30m"
                            className={`w-full bg-white/40 rounded-lg py-2 px-3 text-center font-mono font-bold ${activeColors.text} placeholder-${activeColors.text}/40 outline-none focus:ring-2 focus:ring-white/50`}
                        />
                    </div>

                    {/* Due Date */}
                    <div className="space-y-1">
                        <label className={`text-xs font-bold uppercase tracking-wider ${activeColors.text} opacity-80 flex items-center gap-1`}>
                            <Calendar className="w-3 h-3" /> Due Date
                        </label>
                        <div className="relative">
                            <input
                                type="date"
                                value={activeTask.dueDate ? new Date(activeTask.dueDate).toISOString().split('T')[0] : ''}
                                onChange={(e) => {
                                    const dateValue = e.target.value;
                                    if (dateValue) {
                                        const timestamp = new Date(dateValue).getTime();
                                        updateTask(activeTask.id, 'dueDate', timestamp);
                                    } else {
                                        updateTask(activeTask.id, 'dueDate', null);
                                    }
                                }}
                                className={`w-full bg-white/50 backdrop-blur-sm rounded-xl py-2.5 px-4 text-center font-mono font-semibold ${activeColors.text} outline-none focus:ring-2 focus:ring-white/60 focus:bg-white/60 transition-all shadow-sm hover:shadow-md date-input-elegant`}
                            />
                        </div>
                        {activeTask.dueDate && (() => {
                            const daysLeft = getDaysLeft(activeTask.dueDate);
                            const avgHours = getAvgHoursPerDay(activeTask.quotaMinutes, activeTask.elapsed, daysLeft);
                            return (
                                <div className={`text-xs ${activeColors.text} opacity-70 mt-1 text-center`}>
                                    {daysLeft !== null && daysLeft > 0 && (
                                        <span>{daysLeft} {daysLeft === 1 ? 'day' : 'days'} left</span>
                                    )}
                                    {avgHours !== null && avgHours > 0 && daysLeft > 0 && (
                                        <span className="block mt-0.5">{avgHours.toFixed(1)}h/day needed</span>
                                    )}
                                    {daysLeft !== null && daysLeft <= 0 && (
                                        <span className="text-red-500 font-semibold">
                                            {daysLeft === 0 ? 'Due today!' : `Overdue by ${Math.abs(daysLeft)} ${Math.abs(daysLeft) === 1 ? 'day' : 'days'}`}
                                        </span>
                                    )}
                                </div>
                            );
                        })()}
                    </div>

                    {/* Log Offline Time */}
                    <div className="space-y-1">
                    <label className={`text-xs font-bold uppercase tracking-wider ${activeColors.text} opacity-80 flex items-center gap-1`}>
                        <History className="w-3 h-3" /> Log Offline Time
                    </label>
                    <SmartInput
                        valueMinutes={0}
                        onCommit={(mins) => addManualTime(activeTask.id, mins)}
                        unit="m"
                        placeholder=""
                        className={`w-full bg-white/40 rounded-lg py-2 px-3 font-mono font-bold ${activeColors.text} placeholder-${activeColors.text}/40 outline-none focus:ring-2 focus:ring-white/50`}
                    />
                    </div>
                </div>

                {/* History Log */}
                <div className="border-t border-white/20 pt-4 mt-2">
                    <button 
                        onClick={() => setIsHistoryOpen(!isHistoryOpen)}
                        className={`flex items-center justify-between w-full text-xs font-bold uppercase tracking-wider ${activeColors.text} opacity-80 mb-2 hover:opacity-100`}
                    >
                        <span className="flex items-center gap-1"><History className="w-3 h-3" /> History</span>
                        {isHistoryOpen ? <ChevronDown className="w-3 h-3" /> : <ChevronRight className="w-3 h-3" />}
                    </button>
                    
                    {isHistoryOpen && (
                        <div className="max-h-40 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                            {activeTask.history.length === 0 ? (
                                <div className={`text-xs opacity-50 italic ${activeColors.text}`}>No history yet</div>
                            ) : (
                                activeTask.history.map((entry) => {
                                    const isEditing = editingHistoryId === entry.id;
                                    const mins = Math.round(entry.amount / 60);
                                    
                                    return (
                                    <div key={entry.id} className="group/item flex justify-between items-center text-xs bg-white/30 p-2 rounded-lg hover:bg-white/40 transition-colors">
                                        <div className="flex items-center gap-2">
                                           <span className={`${activeColors.text} opacity-70 font-mono`}>
                                              {formatHistoryDate(entry.timestamp)}
                                           </span>
                                        </div>

                                        <div className="flex items-center gap-2">
                                           {isEditing ? (
                                              <div className="flex items-center gap-1">
                                                <SmartInput
                                                  valueMinutes={mins}
                                                  onCommit={(newVal) => updateHistoryEntry(activeTask.id, entry.id, newVal)}
                                                  unit="m"
                                                  className={`w-10 bg-white rounded px-1 py-0.5 text-center font-bold ${activeColors.text}`}
                                                />
                                              </div>
                                           ) : (
                                              <span className={`${activeColors.text} font-bold`}>
                                                  {entry.type === 'manual' ? '+' : ''}{mins}m
                                              </span>
                                           )}
                                           
                                           {/* Edit Controls (Visible on Hover) */}
                                           {!isEditing && (
                                             <div className="flex gap-1 opacity-0 group-hover/item:opacity-100 transition-opacity">
                                                <button 
                                                  onClick={() => setEditingHistoryId(entry.id)}
                                                  className={`p-1 hover:bg-white/50 rounded ${activeColors.text}`}
                                                  title="Edit"
                                                >
                                                  <Pencil className="w-3 h-3" />
                                                </button>
                                                <button 
                                                  onClick={() => deleteHistoryEntry(activeTask.id, entry.id)}
                                                  className={`p-1 hover:bg-red-100 rounded text-red-500`}
                                                  title="Delete"
                                                >
                                                  <Trash2 className="w-3 h-3" />
                                                </button>
                                             </div>
                                           )}
                                        </div>
                                    </div>
                                )})
                            )}
                        </div>
                    )}
                </div>

              </div>
            </div>
          </div>
        </div>
      )}

      <style>{`
        @keyframes stripes {
          0% { background-position: 0 0; }
          100% { background-position: 20px 0; }
        }
        .animate-stripes {
          animation: stripes 1s linear infinite;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
        }
        
        /* Elegant Date Input Styling */
        .date-input-elegant {
          cursor: pointer;
        }
        
        .date-input-elegant::-webkit-calendar-picker-indicator {
          cursor: pointer;
          opacity: 0.7;
          filter: invert(0.3);
          padding: 4px;
          border-radius: 4px;
          transition: all 0.2s ease;
        }
        
        .date-input-elegant::-webkit-calendar-picker-indicator:hover {
          opacity: 1;
          background: rgba(255, 255, 255, 0.2);
          transform: scale(1.1);
        }
        
        .date-input-elegant::-webkit-datetime-edit-fields-wrapper {
          padding: 0;
        }
        
        .date-input-elegant::-webkit-datetime-edit-text {
          color: inherit;
          padding: 0 2px;
        }
        
        .date-input-elegant::-webkit-datetime-edit-month-field,
        .date-input-elegant::-webkit-datetime-edit-day-field,
        .date-input-elegant::-webkit-datetime-edit-year-field {
          color: inherit;
          padding: 0 2px;
        }
        
        .date-input-elegant::-webkit-inner-spin-button {
          display: none;
        }
        
        /* Firefox date input styling */
        .date-input-elegant::-moz-focus-inner {
          border: 0;
        }
        
        /* For the calendar popup itself (limited browser support) */
        @supports (-webkit-appearance: none) {
          .date-input-elegant::-webkit-calendar-picker-indicator {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
            background-size: 16px 16px;
            background-repeat: no-repeat;
            background-position: center;
            width: 20px;
            height: 20px;
            margin-left: 4px;
          }
        }
      `}</style>
    </div>
  );
}